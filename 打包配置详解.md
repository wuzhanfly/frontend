# Distroless Docker 镜像打包配置详解

## 脚本概述
`tools/scripts/jan.build.distroless.docker.sh` 是一个用于构建 Blockscout 前端 distroless Docker 镜像的脚本，它会创建一个极简的安全镜像，仅包含运行应用程序所需的最小依赖。

## 主要功能
1. 清理旧的构建资源
2. 创建构建日志目录
3. 提取 Git 信息用于镜像标签
4. 从 .env.local 加载构建时环境变量
5. 构建 Docker 镜像
6. 导出镜像为 tar 文件
7. 压缩镜像文件

## 详细配置项解析

### 1. 资源清理配置
```bash
# 删除之前生成的配置资源
rm -rf ./public/assets/configs
rm -rf ./public/assets/multichain
rm -rf ./public/assets/envs.js
```
- **作用**: 清理之前构建生成的配置文件，确保全新构建
- **路径说明**: 
  - `./public/assets/configs` - 应用配置文件
  - `./public/assets/multichain` - 多链配置文件
  - `./public/assets/envs.js` - 客户端环境变量文件

### 2. 构建日志配置
```bash
# 创建 build_info 目录
mkdir -p ./build_info

# 获取当前日期时间作为日志文件名
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="./build_info/build_$TIMESTAMP.log"
```
- **作用**: 创建构建日志记录机制
- **日志位置**: `./build_info/` 目录
- **日志文件命名**: `build_YYYYMMDD_HHMMSS.log`

### 3. Git 信息提取配置
```bash
# 获取 git 信息
GIT_COMMIT_SHA=$(git rev-parse --short HEAD)
GIT_TAG=$(git describe --tags --abbrev=0)
```
- **GIT_COMMIT_SHA**: 提取当前提交的短哈希值
- **GIT_TAG**: 提取最新的 Git 标签
- **用途**: 用于镜像构建参数，提供版本信息

### 4. 环境变量加载配置
```bash
# 从 .env.local 文件解析环境变量并传递给 docker build
ENV_ARGS=""
if [ -f .env.local ]; then
    echo "Loading environment variables from .env.local"
    # 解析 .env.local 文件，跳过注释行并为每个变量设置构建参数
    while IFS= read -r line; do
        # 跳过注释和空行
        if [[ $line =~ ^# ]] || [[ -z $line ]]; then
            continue
        fi
        
        # 检查是否包含等号
        if [[ $line == *"="* ]]; then
            key=$(echo $line | cut -d '=' -f 1)
            value=$(echo $line | cut -d '=' -f 2-)
            # 使用单引号包围值以处理特殊字符
            ENV_ARGS="$ENV_ARGS --build-arg $key='$value'"
        fi
    done < .env.local
fi
```
- **源文件**: `.env.local` - 本地环境配置文件
- **处理规则**:
  - 跳过以 `#` 开头的注释行
  - 跳过空行
  - 提取 `KEY=VALUE` 格式的变量
  - 转换为 Docker 构建参数 `--build-arg KEY='VALUE'`
- **安全性**: 使用单引号包围值以处理特殊字符

### 5. Docker 构建配置
```bash
# 构建 Docker 镜像，传递必要的构建参数
# 使用数组来安全地构建命令
build_cmd=(docker build -f Dockerfile_distroless_minimal)
build_cmd+=(--progress=plain --no-cache)
build_cmd+=(--build-arg GIT_COMMIT_SHA="$GIT_COMMIT_SHA")
build_cmd+=(--build-arg GIT_TAG="$GIT_TAG")

# 添加从 .env.local 解析的环境变量
while IFS= read -r line; do
    if [[ $line =~ ^# ]] || [[ -z $line ]]; then
        continue
    fi
    
    if [[ $line == *"="* ]]; then
        key=$(echo $line | cut -d '=' -f 1)
        value=$(echo $line | cut -d '=' -f 2-)
        build_cmd+=(--build-arg "$key=$value")
    fi
done < .env.local

build_cmd+=(-t blockscout-frontend:distroless ./)
```
- **Dockerfile**: `Dockerfile_distroless_minimal` - 专用于 distroless 的构建文件
- **构建参数**:
  - `--progress=plain` - 使用纯文本进度显示
  - `--no-cache` - 禁用构建缓存，确保全新构建
  - `--build-arg` - 传递构建时环境变量
- **镜像标签**: `blockscout-frontend:distroless`
- **构建上下文**: 当前目录 (.)

### 6. 镜像导出配置
```bash
# 创建 docker_build_file 目录
mkdir -p ./docker_build_file

# 导出 Docker 镜像为 tar 文件
TAR_FILE="./docker_build_file/blockscout-frontend-distroless-$(date +"%Y%m%d%H%M%S").tar"
echo "Exporting Docker image to $TAR_FILE" | tee -a $LOG_FILE
docker save -o "$TAR_FILE" blockscout-frontend:distroless 2>&1 | tee -a $LOG_FILE
```
- **导出目录**: `./docker_build_file/`
- **文件命名**: `blockscout-frontend-distroless-YYYYMMDDHHMMSS.tar`
- **导出命令**: `docker save` - 将镜像保存为 tar 文件

### 7. 镜像压缩配置
```bash
# 压缩 tar 文件以减小大小
echo "Compressing $TAR_FILE" | tee -a $LOG_FILE
gzip "$TAR_FILE" 2>&1 | tee -a $LOG_FILE
```
- **压缩格式**: gzip
- **输出文件**: `$TAR_FILE.gz`

## 构建流程
1. **初始化**: 清理旧资源，创建日志目录
2. **环境准备**: 提取 Git 信息，加载环境变量
3. **镜像构建**: 使用 Dockerfile_distroless_minimal 构建镜像
4. **镜像导出**: 将构建的镜像保存为 tar 文件
5. **镜像压缩**: 使用 gzip 压缩镜像文件
6. **日志记录**: 记录构建过程和结果

## 关键构建参数
- **GIT_COMMIT_SHA**: 当前提交的哈希值
- **GIT_TAG**: 当前 Git 标签
- **.env.local 中的所有变量**: 作为构建参数传递给镜像

## 输出产物
1. **Docker 镜像**: `blockscout-frontend:distroless`
2. **镜像文件**: `./docker_build_file/blockscout-frontend-distroless-{timestamp}.tar`
3. **压缩文件**: `./docker_build_file/blockscout-frontend-distroless-{timestamp}.tar.gz`
4. **构建日志**: `./build_info/build_{timestamp}.log`

## 注意事项
- 需要预先存在 `.env.local` 配置文件
- 构建过程中会禁用缓存确保全新构建
- 生成的镜像是 distroless 类型，仅包含运行时依赖
- 镜像导出和压缩过程会被记录到日志文件