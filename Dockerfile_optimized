# ****************************
# *** STAGE 1: Dependencies ***
# ****************************
FROM node:22.11.0-alpine AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat python3 make g++ bash git && \
    corepack enable && \
    corepack prepare yarn@4.10.3 --activate

# 设置工作目录
WORKDIR /app

# 写入 .yarnrc.yml，保证 Yarn 使用国内镜像，vanilla-extract 使用官方源
RUN echo "nodeLinker: node-modules" > .yarnrc.yml && \
    echo "npmRegistryServer: \"https://registry.npmmirror.com\"" >> .yarnrc.yml && \
    echo "enableTelemetry: false" >> .yarnrc.yml && \
    echo "enableImmutableInstalls: true" >> .yarnrc.yml && \
    echo "npmScopes:" >> .yarnrc.yml && \
    echo "  vanilla-extract:" >> .yarnrc.yml && \
    echo "    npmRegistryServer: \"https://registry.yarnpkg.com\"" >> .yarnrc.yml

### APP
# Install dependencies
COPY package.json yarn.lock tsconfig.json ./
COPY types ./types
COPY lib ./lib
COPY configs/app ./configs/app
COPY toolkit/theme ./toolkit/theme
COPY toolkit/utils ./toolkit/utils
COPY toolkit/components/forms/validators/url.ts ./toolkit/components/forms/validators/url.ts
RUN yarn install --network-timeout 200000 --immutable

### FEATURE REPORTER
# Install dependencies
WORKDIR /feature-reporter
COPY ./deploy/tools/feature-reporter/package.json ./
# 检查并创建缺失的配置文件
RUN if [ -f ./deploy/tools/feature-reporter/.yarnrc.yml ]; then cp ./deploy/tools/feature-reporter/.yarnrc.yml ./; else echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    if [ ! -f ./deploy/tools/feature-reporter/yarn.lock ]; then touch yarn.lock; fi && \
    echo "Installing dependencies for feature-reporter" && \
    yarn install --network-timeout 200000 --immutable && \
    echo "Installation completed for feature-reporter"

### ENV VARIABLES CHECKER
# Install dependencies
WORKDIR /envs-validator
COPY ./deploy/tools/envs-validator/package.json ./deploy/tools/envs-validator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ ! -f ./deploy/tools/envs-validator/yarn.lock ]; then touch yarn.lock; fi && \
    if [ ! -f ./.yarnrc.yml ]; then echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    yarn install --network-timeout 100000 --immutable

### FAVICON GENERATOR
# Install dependencies
WORKDIR /favicon-generator
COPY ./deploy/tools/favicon-generator/package.json ./deploy/tools/favicon-generator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ ! -f ./deploy/tools/favicon-generator/yarn.lock ]; then touch yarn.lock; fi && \
    if [ ! -f ./.yarnrc.yml ]; then echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    yarn install --network-timeout 100000 --immutable

### SITEMAP GENERATOR
# Install dependencies
WORKDIR /sitemap-generator
COPY ./deploy/tools/sitemap-generator/package.json ./deploy/tools/sitemap-generator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ ! -f ./deploy/tools/sitemap-generator/yarn.lock ]; then touch yarn.lock; fi && \
    if [ ! -f ./.yarnrc.yml ]; then echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    yarn install --network-timeout 100000 --immutable

### MULTICHAIN CONFIG GENERATOR
# Install dependencies
WORKDIR /multichain-config-generator
COPY ./deploy/tools/multichain-config-generator/package.json ./deploy/tools/multichain-config-generator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ -f ./deploy/tools/multichain-config-generator/.yarnrc.yml ]; then cp ./deploy/tools/multichain-config-generator/.yarnrc.yml ./; else echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    if [ ! -f ./deploy/tools/multichain-config-generator/yarn.lock ]; then touch yarn.lock; fi && \
    echo "Installing dependencies for multichain-config-generator" && \
    yarn install --frozen-lockfile --network-timeout 100000 --immutable

### ESSENTIAL DAPPS CHAINS CONFIG GENERATOR
# Install dependencies
WORKDIR /essential-dapps-chains-config-generator
COPY ./deploy/tools/essential-dapps-chains-config-generator/package.json ./deploy/tools/essential-dapps-chains-config-generator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ -f ./deploy/tools/essential-dapps-chains-config-generator/.yarnrc.yml ]; then cp ./deploy/tools/essential-dapps-chains-config-generator/.yarnrc.yml ./; else echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    if [ ! -f ./deploy/tools/essential-dapps-chains-config-generator/yarn.lock ]; then touch yarn.lock; fi && \
    echo "Installing dependencies for essential-dapps-chains-config-generator" && \
    yarn install --frozen-lockfile --network-timeout 100000 --immutable

### llms.txt GENERATOR
# Install dependencies
WORKDIR /llms-txt-generator
COPY ./deploy/tools/llms-txt-generator/package.json ./deploy/tools/llms-txt-generator/yarn.lock ./
# 检查并创建缺失的配置文件
RUN if [ -f ./deploy/tools/llms-txt-generator/.yarnrc.yml ]; then cp ./deploy/tools/llms-txt-generator/.yarnrc.yml ./; else echo "nodeLinker: node-modules" > .yarnrc.yml; fi && \
    if [ ! -f ./deploy/tools/llms-txt-generator/yarn.lock ]; then touch yarn.lock; fi && \
    echo "Installing dependencies for llms-txt-generator" && \
    yarn install --frozen-lockfile --network-timeout 100000 --immutable

# *****************************
# ****** STAGE 2: Build *******
# *****************************
FROM node:22.11.0-alpine AS builder
RUN apk add --no-cache --upgrade libc6-compat bash jq && \
    corepack enable && \
    corepack prepare yarn@4.10.3 --activate

# pass build args to env variables
ARG GIT_COMMIT_SHA
ENV NEXT_PUBLIC_GIT_COMMIT_SHA=$GIT_COMMIT_SHA
ARG GIT_TAG
ENV NEXT_PUBLIC_GIT_TAG=$GIT_TAG
ARG NEXT_OPEN_TELEMETRY_ENABLED
ENV NEXT_OPEN_TELEMETRY_ENABLED=$NEXT_OPEN_TELEMETRY_ENABLED

ENV NODE_ENV=production

### APP
# Copy dependencies and source code
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Build SVG sprite and generate .env.registry with ENVs list and save build args into .env file
RUN set -a && \
    source ./deploy/scripts/build_sprite.sh && \
    ./deploy/scripts/collect_envs.sh ./docs/ENVS.md && \
    set +a

# Build app for production
ENV NODE_OPTIONS="--max-old-space-size=4096"
# 删除feature-reporter中的build目录以避免构建时扫描错误的配置文件
RUN find ./deploy/tools/feature-reporter -name "build" -type d -exec rm -rf {} + 2>/dev/null || true && \
    NEXT_LINT=false yarn build

### FEATURE REPORTER
# Copy dependencies and source code, then build
COPY --from=deps /feature-reporter/node_modules ./deploy/tools/feature-reporter/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/feature-reporter && if [ ! -f yarn.lock ]; then touch yarn.lock; fi && \
    yarn compile_config && \
    yarn build

### ENV VARIABLES CHECKER
# Copy dependencies and source code, then build
COPY --from=deps /envs-validator/node_modules ./deploy/tools/envs-validator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/envs-validator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi && \
    yarn build

### FAVICON GENERATOR
# Copy dependencies and source code
COPY --from=deps /favicon-generator/node_modules ./deploy/tools/favicon-generator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/favicon-generator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi

### SITEMAP GENERATOR
# Copy dependencies and source code
COPY --from=deps /sitemap-generator/node_modules ./deploy/tools/sitemap-generator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/sitemap-generator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi

### MULTICHAIN CONFIG GENERATOR
# Copy dependencies and source code, then build
COPY --from=deps /multichain-config-generator/node_modules ./deploy/tools/multichain-config-generator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/multichain-config-generator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi && \
    yarn build

### ESSENTIAL DAPPS CHAINS CONFIG GENERATOR
# Copy dependencies and source code, then build
COPY --from=deps /essential-dapps-chains-config-generator/node_modules ./deploy/tools/essential-dapps-chains-config-generator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/essential-dapps-chains-config-generator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi && \
    yarn build

### llms.txt GENERATOR
# Copy dependencies and source code, then build
COPY --from=deps /llms-txt-generator/node_modules ./deploy/tools/llms-txt-generator/node_modules
# 检查并创建缺失的配置文件以避免工作区问题
RUN cd ./deploy/tools/llms-txt-generator && if [ ! -f yarn.lock ]; then touch yarn.lock; fi && \
    yarn build

# *****************************
# ******* STAGE 3: Run ********
# *****************************
# Production image, copy all the files and run next
FROM node:22.11.0-alpine AS runner
RUN apk add --no-cache --upgrade bash curl jq && \
    addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

WORKDIR /app

# Set the correct permission for prerender cache
RUN mkdir .next && \
    chown nextjs:nodejs .next

# Copy only the necessary files for production
COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/package.json ./

# Copy tools
COPY --from=builder /app/deploy/tools/envs-validator/index.js ./envs-validator.js
COPY --from=builder /app/deploy/tools/feature-reporter/dist ./deploy/tools/feature-reporter/dist
COPY --from=builder /app/deploy/tools/multichain-config-generator/dist ./deploy/tools/multichain-config-generator/dist
COPY --from=builder /app/deploy/tools/llms-txt-generator/dist ./deploy/tools/llms-txt-generator/dist
COPY --from=builder /app/deploy/tools/essential-dapps-chains-config-generator/dist ./deploy/tools/essential-dapps-chains-config-generator/dist

# Copy scripts
COPY --chmod=755 ./deploy/scripts/entrypoint.sh .
COPY --chmod=755 ./deploy/scripts/validate_envs.sh .
COPY --chmod=755 ./deploy/scripts/make_envs_script.sh .
COPY --chmod=755 ./deploy/scripts/download_assets.sh .
COPY ./deploy/scripts/og_image_generator.js .
COPY --chmod=755 ./deploy/scripts/favicon_generator.sh .
COPY --from=builder /app/deploy/tools/favicon-generator ./deploy/tools/favicon-generator
COPY --chmod=755 ./deploy/scripts/sitemap_generator.sh .
COPY --from=builder /app/deploy/tools/sitemap-generator ./deploy/tools/sitemap-generator

# Set permissions
RUN chmod -R 755 ./deploy/tools/favicon-generator && \
    chmod -R 755 ./public

# Copy ENVs files
COPY --from=builder /app/.env.registry .
COPY --from=builder /app/.env .

# Copy ENVs presets
ARG ENVS_PRESET
ENV ENVS_PRESET=$ENVS_PRESET
COPY ./configs/envs ./configs/envs

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

ENTRYPOINT ["./entrypoint.sh"]

USER nextjs

EXPOSE 3000

ENV PORT=3000

CMD ["node", "server.js"]
