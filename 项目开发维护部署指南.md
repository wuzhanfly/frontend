# Blockscout Frontend 项目开发、维护与部署指南

## 项目概述

Blockscout Frontend 是一个基于 Next.js 框架开发的区块链浏览器前端应用程序，使用 TypeScript 构建，采用 Chakra UI 作为 UI 组件库。

### 技术栈

- **框架**: Next.js 15.5.2 (React 19)
- **语言**: TypeScript 5.9.2
- **UI 库**: Chakra UI 3.15.0
- **状态管理**: TanStack Query (React Query) 5.68.0
- **样式**: Emotion
- **测试**: Playwright (E2E), Jest (单元测试)
- **部署**: Docker
- **包管理器**: Yarn 1.22.22

### 环境要求

- Node.js: 22.11.0
- npm: 10.9.0
- Docker (用于部署)

## 项目结构

```
frontend/
├── configs/              # 配置文件
│   ├── app/             # 应用配置
│   ├── envs/            # 环境变量配置
│   ├── essential-dapps-chains/  # DApps 链配置
│   └── multichain/      # 多链配置
├── deploy/              # 部署相关
│   ├── scripts/         # 部署脚本
│   ├── tools/           # 部署工具
│   └── values/          # Helm 值文件
├── icons/               # SVG 图标
├── lib/                 # 工具库
├── pages/               # Next.js 页面
├── public/              # 静态资源
├── src/                 # 源代码
├── tools/               # 开发工具
├── ui/                  # UI 组件
├── Dockerfile           # Docker 构建文件
├── next.config.js       # Next.js 配置
├── package.json         # 项目依赖
└── tsconfig.json        # TypeScript 配置
```

## 开发流程

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/blockscout/frontend.git
cd frontend

# 安装主项目依赖
yarn install

# 安装工具工程依赖（重要：Docker 构建前必须执行）
cd deploy/tools/feature-reporter && yarn install
cd ../envs-validator && yarn install
cd ../favicon-generator && yarn install
cd ../sitemap-generator && yarn install
cd ../multichain-config-generator && yarn install
cd ../essential-dapps-chains-config-generator && yarn install
cd ../llms-txt-generator && yarn install

# 返回根目录
cd ../../..

# 复制环境变量文件
cp .env.example .env.local
# 编辑 .env.local 配置必要的环境变量
```

### 2. 本地开发

#### 启动开发服务器

```bash
# 使用默认配置启动
yarn dev

# 或使用预设配置启动
yarn dev:preset <preset_name>
```

开发服务器默认运行在 `http://localhost:3000`

#### 开发脚本说明

- `yarn dev`: 启动开发服务器，自动下载配置、构建 SVG 精灵图、生成环境变量脚本
- `yarn dev:preset`: 使用预设配置启动（需要提供预设名称）
- `yarn dev:preset:sync`: 同步预设配置

### 3. 代码规范

#### ESLint 配置

项目使用 ESLint 进行代码检查，配置文件：`eslint.config.mjs`

```bash
# 运行 ESLint 检查
yarn lint:eslint

# 自动修复 ESLint 错误
yarn lint:eslint:fix

# TypeScript 类型检查
yarn lint:tsc
```

#### Git Hooks

项目使用 Husky 配置 Git hooks：

- **pre-commit**: 运行 lint-staged 检查代码格式化 SVG 文件
- **pre-push**: 运行测试
- **post-commit/post-merge/post-checkout**: Git LFS 相关（已禁用）

#### 提交规范

提交前会自动运行：
- ESLint 检查和修复
- SVG 文件格式化
- 确保所有暂存文件符合代码规范

### 4. 测试

#### 单元测试 (Jest)

```bash
# 运行所有测试
yarn test:jest

# 监听模式运行测试
yarn test:jest:watch
```

#### 端到端测试 (Playwright)

```bash
# 本地运行 E2E 测试
yarn test:pw:local

# Docker 中运行 E2E 测试
yarn test:pw:docker

# CI 环境运行特定项目测试
yarn test:pw:ci

# 检测受影响的测试
yarn test:pw:detect-affected
```

## 维护流程

### 1. 依赖管理

```bash
# 添加新依赖
yarn add <package-name>

# 添加开发依赖
yarn add -D <package-name>

# 更新依赖
yarn upgrade

# 检查过期依赖
yarn outdated
```

### 2. SVG 图标管理

```bash
# 格式化 SVG 文件
yarn svg:format

# 构建 SVG 精灵图
yarn svg:build-sprite
```

SVG 精灵图会生成在 `public/icons/sprite.<hash>.svg`，并创建 `sprite.svg` 符号链接。

### 3. 资源生成

```bash
# 生成 favicon
yarn favicon:generate:dev

# 生成 OG 图片
yarn og-image:generate:dev

# 生成 sitemap
yarn sitemap:generate:dev
```

### 4. Chakra UI 主题

```bash
# 添加 Chakra UI 代码片段
yarn chakra:snippets:add

# 生成主题类型
yarn chakra:typegen
```

### 5. 环境变量验证

```bash
# 验证环境变量
yarn lint:envs-validator:test
```

## 部署流程

### 1. 构建项目

```bash
# 基础构建
yarn build

# 完整构建（包含资源下载）
yarn build:next
```

构建输出在 `.next` 目录，为 standalone 模式。

### 2. Docker 构建

#### 构建 Docker 镜像

```bash
# 构建 Docker 镜像
yarn build:docker
```

Docker 构建过程：
1. 使用多阶段构建
2. 安装依赖
3. 构建应用
4. 生成最终镜像

#### Docker 镜像运行

```bash
# 本地运行镜像
yarn start:docker:local

# 使用预设配置运行
yarn start:docker:preset <preset_name>
```

### 3. 生产环境部署

#### 环境变量配置

生产环境需要配置以下关键环境变量：

```bash
# 必需
NEXT_PUBLIC_NETWORK_NAME=网络名称
NEXT_PUBLIC_NETWORK_ID=链ID
NEXT_PUBLIC_API_HOST=后端API主机

# 可选
NEXT_PUBLIC_APP_PORT=3000
NEXT_PUBLIC_APP_ENV=production
NEXT_PUBLIC_ICON_SPRITE_HASH=<精灵图哈希>
```

#### Docker Compose 部署

```yaml
version: '3'
services:
  frontend:
    image: blockscout-frontend:latest
    ports:
      - "3000:3000"
    env_file:
      - .env.production
    restart: unless-stopped
```

#### Kubernetes 部署

项目提供 Helmfile 配置用于 Kubernetes 部署：

```bash
# 使用 Helmfile 部署
helmfile apply
```

### 4. 监控

#### Prometheus 监控

```bash
# 本地运行 Prometheus
yarn monitoring:prometheus:local
```

#### Grafana 仪表板

```bash
# 本地运行 Grafana
yarn monitoring:grafana:local
```

## 常见问题

### 1. nvm PREFIX 环境变量错误

如果遇到 `nvm is not compatible with the "PREFIX" environment variable` 错误：

```bash
# 临时解决
unset PREFIX

# 永久解决（在 .bashrc 或 .zshrc 中添加）
unset PREFIX
```

### 2. Docker 构建网络问题

如果 Docker 无法连接到 Docker Hub：

1. 使用国内镜像源（已配置 DaoCloud 镜像源）
2. 或配置 Docker daemon 使用镜像源：
   ```json
   {
     "registry-mirrors": [
       "https://docker.m.daocloud.io"
     ]
   }
   ```

### 3. Git 标签错误

如果遇到 Git 标签相关错误：

```bash
# 使用 --always 参数
git describe --tags --abbrev=0 --always
```

### 4. SVG 精灵图 404 错误

如果遇到 SVG 精灵图 404 错误：

```bash
# 重新构建精灵图
yarn svg:build-sprite

# 创建符号链接
cd public/icons
ln -sf sprite.<hash>.svg sprite.svg

# 重启开发服务器
```

### 5. 端口占用

如果 3000 端口被占用：

```bash
# 查找占用端口的进程
ss -tlnp | grep :3000

# 终止进程
kill -9 <PID>
```

### 6. Docker 构建工具依赖错误

如果遇到 Docker 构建时工具工程的 yarn 安装失败：

```bash
# 重新生成所有工具工程的 yarn.lock 文件
cd deploy/tools/feature-reporter && rm -f yarn.lock && yarn install
cd ../envs-validator && rm -f yarn.lock && yarn install
cd ../favicon-generator && rm -f yarn.lock && yarn install
cd ../sitemap-generator && rm -f yarn.lock && yarn install
cd ../multichain-config-generator && rm -f yarn.lock && yarn install
cd ../essential-dapps-chains-config-generator && rm -f yarn.lock && yarn install
cd ../llms-txt-generator && rm -f yarn.lock && yarn install

# 返回根目录
cd ../../..
```

**重要提示**：在执行 `yarn build:docker` 前，必须确保所有工具工程的依赖都已正确安装，否则会导致 Docker 构建失败。

### 7. Docker 运行时环境变量一致性检查失败

如果遇到 Docker 运行时环境变量一致性检查失败：

#### 快速解决方案（推荐）

**方案1：跳过一致性检查**
```bash
# 在 .env.local 文件末尾添加
echo "SKIP_RUNTIME_PLACEHOLDER_CHECK=true" >> .env.local

# 重新运行 Docker 容器
docker run -p 3000:3000 --env-file .env.local blockscout-frontend:local
```

**方案2：临时移除问题变量**
```bash
# 从 .env.local 中临时注释掉这些变量
# NEXT_PUBLIC_OP_SUPERCHAIN_ENABLED=false
# NEXT_PUBLIC_MULTICHAIN_AGGREGATOR_API_HOST=

# 重新运行 Docker 容器
docker run -p 3000:3000 --env-file .env.local blockscout-frontend:local
```

**方案3：运行时设置环境变量**
```bash
# 直接在运行时设置
docker run -p 3000:3000 --env-file .env.local -e SKIP_RUNTIME_PLACEHOLDER_CHECK=true blockscout-frontend:local
```

#### 根本解决方案

更新 `.env.registry` 文件，添加缺失的环境变量占位符：

```bash
# 在 .env.registry 文件中添加以下行
NEXT_PUBLIC_OP_SUPERCHAIN_ENABLED=__
NEXT_PUBLIC_MULTICHAIN_AGGREGATOR_API_HOST=__

# 重新构建 Docker 镜像
yarn build:docker
```

#### 常见运行时异常及处理

**1. Favicon 生成失败**
```
Error: FAVICON_MASTER_URL or NEXT_PUBLIC_NETWORK_ICON must be set
```
解决：在 `.env.local` 中添加网络图标 URL
```bash
echo "NEXT_PUBLIC_NETWORK_ICON=https://example.com/icon.png" >> .env.local
```

**2. API 连接超时**
```
TypeError: fetch failed
[cause]: [AggregateError: ] { code: 'ETIMEDOUT' }
```
解决：检查后端 API 服务是否正常运行，或使用本地测试环境

**3. 模块类型警告**
```
Warning: Module type of file is not specified
```
解决：这是非关键警告，不影响应用运行，可忽略

#### 快速校验清单

运行 Docker 容器后，通过以下方式快速校验是否正常：

```bash
# 1. 检查容器是否启动成功
docker ps | grep blockscout-frontend

# 2. 检查应用日志中的关键信息
docker logs <container_id> | grep -E "(Ready|Starting|Error)"

# 3. 访问应用首页
curl -I http://localhost:3000

# 4. 检查 API 连接状态
curl -I http://localhost:3000/api/v1/health
```

**正常启动标志**：
- 看到 `✓ Ready in XXXms` 消息
- 应用监听在 3000 端口
- 可以通过浏览器访问 http://localhost:3000

**可忽略的警告**：
- 模块类型警告
- 部分资源下载跳过提示
- sitemap 生成超时（不影响核心功能）

## 最佳实践

### 1. 开发建议

- 使用 TypeScript 严格模式
- 遵循 ESLint 和 Prettier 配置
- 编写单元测试和 E2E 测试
- 使用预设配置管理不同环境

### 2. 性能优化

- 使用 Next.js Image 组件优化图片
- 实现代码分割和懒加载
- 优化 Webpack 配置
- 使用 CDN 加速静态资源

### 3. 安全建议

- 使用环境变量管理敏感信息
- 定期更新依赖
- 启用 CSP (Content Security Policy)
- 使用 HTTPS

### 4. 部署建议

- 使用 Docker 容器化部署
- 配置健康检查
- 设置适当的资源限制
- 使用 CI/CD 自动化部署

## 贡献指南

1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

## 许可证

本项目采用开源许可证，详情请参见 LICENSE 文件。

## 联系方式

- 项目主页: https://github.com/blockscout/frontend
- 问题反馈: https://github.com/blockscout/frontend/issues